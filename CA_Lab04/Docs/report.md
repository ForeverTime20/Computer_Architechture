# 计算机体系结构实验四 实验报告

蒋滨泽	PB18030971

## 一、分析分支收益和分支代价

1. 一个分支在没有预测的情况下发生跳转的分支代价固定为2个周期。预测成功的情况下收益为2个周期。
2. 对于一个循环N次的循环体，有N-1次跳转的分支和1次不跳转的分支
   - 无分支预测下，分支代价为2(N-1)个周期
   - BTB预测的分支代价为2\*2=4个周期（第一次跳转的分支和最后一次不跳转的分支预测错误）
   - 2-bit BHT预测的分支代价为2*3=6个周期（前两次跳转的分支和最后一次不跳转的分支）

在较为复杂的程序测试中，BHT的综合表现要明显好于BTB。

## 二、统计未使用分支预测和使用分支预测的总周期数及差值，分支指令数目、动态分支预测正确次数和错误次数

**注意：由于测试时启用了cache，故总周期数中存在因cache miss而导致的stall。**

BHT与BTB均为256个表项，BHT为2-bit预测器。

### 1.btb.s

|            | 总周期数 | 总分支数 | 预测错误数 | 预测成功数 |
| ---------- | -------- | -------- | ---------- | ---------- |
| 无分支预测 | 510      | 101      | N/A        | N/A        |
| BTB        | 314      | 101      | 2          | 99         |
| BTB+BHT    | 316      | 101      | 3          | 98         |

无分支预测与BTB总周期数差值：+196；与BHT总周期数差值：+194.

BTB与BHT总周期数差值：-2；预测成功数差值：+1.

### 2.bht.s

|            | 总周期数 | 总分支数 | 预测错误数 | 预测成功数 |
| ---------- | -------- | -------- | ---------- | ---------- |
| 无分支预测 | 536      | 110      | N/A        | N/A        |
| BTB        | 382      | 110      | 22         | 88         |
| BTB+BHT    | 368      | 110      | 15         | 95         |

无分支预测与BTB总周期数差值：+154；与BHT总周期数差值：+168.

BTB与BHT总周期数差值：+14；预测成功数差值：-7.

### 3.QuickSort256.s

|            | 总周期数 | 总分支数 | 预测错误数 | 预测成功数 |
| ---------- | -------- | -------- | ---------- | ---------- |
| 无分支预测 | 37708    | 6950     | N/A        | N/A        |
| BTB        | 37086    | 6950     | 1450       | 5500       |
| BTB+BHT    | 36408    | 6950     | 391        | 6559       |

无分支预测与BTB总周期数差值：+622；与BHT总周期数差值：+800.

BTB与BHT总周期数差值：+678；预测成功数差值：-1059.

### 4.MatrixMult16.s

|            | 总周期数 | 总分支数 | 预测错误数 | 预测成功数 |
| ---------- | -------- | -------- | ---------- | ---------- |
| 无分支预测 | 115865   | 4624     | N/A        | N/A        |
| BTB        | 108259   | 4624     | 548        | 4076       |
| BTB+BHT    | 107727   | 4624     | 282        | 4324       |

无分支预测与BTB总周期数差值：+7606；与BHT总周期数差值：+8138.

BTB与BHT总周期数差值：+532；预测成功数差值：-248.

## 三、对比不同策略并分析以上几点的关系

从运行周期数来看，带有分支预测的CPU运行周期数要小于不带分支预测的运行周期数；BHT预测减少的周期数要多于BTB预测所减少的周期数。

在复杂程序的测试中，BHT预测的成功率要明显高于BTB预测的成功率。尤其在快排测试中，BHT的预测效果要明显优于BTB。

从分支预测的角度来看，分支预测成功次数越多，CPU运行时钟周期数越少，总体呈现正相关性，但非线性，可能是由于cache发生miss时的stall所导致。

总的来说，BHT+BTB的效果要明显好于只用BTB的预测器或者不用预测器，在实践中应该采用预测器以提升性能。
